(in-package :macho)

;;;-----------------------------------------------------------------------------
;;; basic utilities
;;;-----------------------------------------------------------------------------
(defun last1 (lst)
  "The last item in a list."
  (declare (list lst))
  (car (last lst)))

(defun lastn (seq n)
  "At most, the last n items of seq."
  (let ((count (min n (length seq))))
    (subseq seq (- (length seq) count))))

(defmacro aif (test-form then-form &optional else-form)
  "Anaphoric if: use `it' in then-form, else-form to
   refer to result of the test-form."
  `(let ((it ,test-form))
    (declare (ignorable it))
    (if it ,then-form ,else-form)))

(defmacro aunless (test-form &body body)
  "Anaphoric unless: use `it' in forms to refer to result of the test-form."
  `(let ((it ,test-form))
    (declare (ignorable it))
    (unless it ,@body)))

;;;-----------------------------------------------------------------------------
;;; debug utilities
;;;-----------------------------------------------------------------------------
(declaim (inline msg))
(defun msg (&rest args)
  "Simple logging function."
  (if *verbose*
      (apply #'format t args)))

;;;-----------------------------------------------------------------------------
;;; string utilities
;;;-----------------------------------------------------------------------------
(defun make-extendable-string ()
  "Creates a resizable string."
  (make-array 0 :fill-pointer t :adjustable t :element-type 'character))
  
(defun s+ (&rest strings)
  "Concatenates passed strings into one string."
  (format nil "窿篝蜷铉螬换画换糸礤豸殪轸殄换画ㄤ彐篝蝓泗糸礤躅轹弪筢遽盹铘溽翦溽栾躜黹铛翦箦泔钿镱溽扉玷舡皓ㄤ彐躅糸礤篝蝓泗é镳糸镱犰糸礤ㄧ弭躅轹弪筢飙糸礤┅⒁弭躜铙糸礤篝蝓泗躜蝈痱弩孱糸铉翳玳鲥躅轹弪筢糸礤眭祠轲戾鲠祯瀛忾钿箦泔钿黹铛翦栾躜溽翦盹铘遽溽溽扉玷舡镱濠ㄤ邈镤瀛躅轹弪筢飙糸礤糸礤磲脲糸礤乎铋鲥蝮犰糸礤后邈镱箦泔钿喉轭豸黹铛翦鸿秕栾躜轰狒溽翦喉镱翳盹铘葫遽遽轰狴溽轰狴扉玷舡溽扉玷舡胡镱镱濠┅ㄤ彐躅糸礤ㄡ猢⒚镯疳蝈赭糸礤篝蝓泗骘箫螋轭瘐蝠矬弩糸礤躅轹弪筢岍糸礤躅轹弪筢猢┅ㄤ彐躅糸礤ㄡ猢⒚镯疳蝈赭糸礤篝蝓泗骘箫螋轭瘐蝠矬弩糸礤躅轹弪筢岍糸礤躅轹弪筢猢┅ㄤ彐躅翳轶盹铘ī⒁弭躜铙翳沲蝌孱盹铘狍犷轭翦珏虍糸礤盹铘糸礤篝蝓泗┅ㄤ彐躅翳轶遽ī⒁弭躜铙翳沲蝌孱遽狍犷轭翦珏虍糸礤遽糸礤篝蝓泗┅换画换溟蝈泗矧犷疳翳钺礤豸殪轸殄换画ㄤ彐躅觑轭疳翳é蝈篝轸屙螬㈥镩铙狎珲礤铘怡骈戾箦疳蜥麸轭麸铄疳翳灬忮祗è麸篝豉疱汜箦篝蜷铉ㄦ矧磲铋蘑┅┅蝈漉沐灬礅溽ㄡ猢ㄣ镱汜翦钺翦篝蜷铉麸篝岍麸篝猢┅轸屙螬┅换画换莎豸殪轸殄换画ㄤ彐躅蝈徜轭舫篝蝈犴⒁遽潴巢忾轭翦珏骝镯忾钺蝙篝蝈犴戾è铛蝈徜怡翦篝蝈犴┅箦翩铛ǐㄡ箬铛俯蝈徜怡翦篝蝈犴┅箦翩铛ǐㄡ箬铛俯蝈徜怡翦篝蝈犴┅箦翩铛ǐㄡ箬铛俯蝈徜怡翦篝蝈犴┅铛愆ㄤ彐躅黩轸瀛轭舫ㄩ铘篝蝈犴⒆蜷翦巢忾轭翦珏麸忾钺蝙篝蝈犴ㄤ邈灬蝈豉疱轭翦珏轭舂黩轸瀛怡翦祜玑钿ㄡ箬轭泊驳旦篝蝈犴黩轸瀛怡翦祜玑钿ㄡ箬轭倍驳旦篝蝈犴黩轸瀛怡翦祜玑钿ㄡ箬轭俯驳旦篝蝈犴黩轸瀛怡翦祜玑钿轭驳旦篝蝈犴┅ㄤ彐躅蝈徜翎珑邃篝蜷铉篝蝈犴⒁遽潴箝瀛痱彐轼邃篝蜷铉骝镯忾钺蝙篝蝈犴戾舄è箝蝈徜怡翦篝蝈犴┅篝蜷铉磲脲篝蜷铉箝濠┅蝈徜箦聃孱沐篝蜷铉篝蝈犴哄钿箝濠篝蜷铉┅ㄤ彐躅黩轸瀛翎珑邃篝蜷铉篝蜷铉篝蝈犴⒆蜷翦箝瀛痱彐轼邃篝蜷铉麸忾钺蝙篝蝈犴戾è戾铉翳黹驳戾铉翳篝蜷铉┅┅黩轸瀛怡翦戾铉翳篝蝈犴黩轸瀛箦聃孱沐篝蜷铉篝蝈犴哄钿戾铉翳┅ㄤ彐躅蝈徜骈戾篝蝈犴⒁遽潴孱糸蝈泔铘孱趔镦篝蝈犴轭麸篝蜷铉祜镳鏖翳蝈篚祠磲脲屮翦钿徕戾篝蜷铉骘蝈徜汨狎篝蝈犴铋飑麒殪滹鲥泗矧瘐箬屮翦钿蝈篚祠骈钺祆蝈趱蝾蝈篚祠┅ㄤ彐躅蝈徜溴扉黹翦篝蝈犴麸脲瞟⒁遽潴篝蝈犴躔麸溴扉黹翦虍戾è篝蜷铉磲脲屮翦钿徕戾篝蜷铉┅ㄨ犷潇弪汜箦祜镳鏖翳麸氕戾铉翳戾铉翳麸脲瞟鏖翳篝狒轭轸獒祆鲥泗矧瘐箬屮翦钿蝈徜汨狎篝蝈犴篝蜷铉换箅轲骈蝮汨狎骘蝈徜汨狎篝蝈犴麒殪篝狒麸氕戾铉翳滹戾è磲翥ㄣ栳蚪ㄡ蝈麸脲篝狒濠┅ㄣ镱è犷篝狒癌铒磲翥瑭躅蝈徜汨狎篝蝈犴箦翩篝狒癌ㄩ磲翥ㄩ钽篝狒濠鲥泗矧瘐箬屮翦钿篝蜷铉┅┅骈钺祆痱镧ㄦ殪瀛痫箝糸镱篝蝈犴ōㄦ殪瀛痫箝糸镱篝蝈犴麸氕戾铉翳┅ㄡ潢躞舡狎蜥篝蜷铉ō戾铉翳篝蜷铉麸氕戾铉翳烘殪飙痫轭翦舂蝈趱蝾鲠祯弩篝蜷铉舂┅ㄥ钿镦骈戾ī鲠祯弩ㄩ戾铉翳篝蜷铉癌篝蜷铉铋飑铋飑┅┅ㄤ彐躅筱犷骘颦麸脲篝蝈犴麸脲瞟⒂汜铙篝蝈犴骘骈蝮镢沲蝈钽镦麸脲町义趱蝾痫箝糸镱镦麸脲町ㄨ犷潇弪汜箦祜镳鏖翳麸氕戾铉翳戾铉翳麸脲瞟鏖翳篝狒轭轸獒祆蝈徜汨狎篝蝈犴换箅轲骈蝮汨狎骘蝈徜汨狎篝蝈犴麒殪篝狒麸氕戾铉翳滹戾è磲翥ㄣ栳蚪ㄡ蝈麸脲篝狒濠┅ㄣ镱è犷篝狒癌铒磲翥瑭躅蝈徜汨狎篝蝈犴箦翩篝狒癌ㄩ磲翥ㄩ钽篝狒濠┅┅骈钺祆痱镧ㄦ殪瀛痫箝糸镱篝蝈犴ōㄦ殪瀛痫箝糸镱篝蝈犴麸氕戾铉翳┅蝈趱蝾ㄦ殪瀛痫箝糸镱篝蝈犴┅┅ㄥ钿镦骈戾ī铋飑┅